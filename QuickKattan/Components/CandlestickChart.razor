@using ApexCharts

<MudCard Elevation="3" Class="ma-2">
    <MudCardHeader>
        <CardHeaderContent>
            <MudText Typo="Typo.h6">Gráfico de Velas - @Symbol</MudText>
            <MudText Typo="Typo.body2">Análisis OHLC (Apertura, Máximo, Mínimo, Cierre)</MudText>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        <div style="height: @Height">
            <ApexChart TItem="CandlestickPoint" 
                       Title="@($"Precio de {Symbol}")"
                       Height="@ChartHeight"
                       Options="@chartOptions">
                
                <ApexPointSeries TItem="CandlestickPoint"
                                 Items="@candlestickData"
                                 Name="@Symbol"
                                 SeriesType="SeriesType.Line"
                                 XValue="@(e => e.X.ToString("yyyy-MM-dd"))"
                                 YValue="@(e => (decimal?)e.Y[3])" />
            </ApexChart>
        </div>
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public string Symbol { get; set; } = "STOCK";
    [Parameter] public List<StockData> Data { get; set; } = new();
    [Parameter] public string Height { get; set; } = "500px";
    
    private int ChartHeight => int.Parse(Height.Replace("px", ""));
    private List<CandlestickPoint> candlestickData = new();
    
    protected override void OnParametersSet()
    {
        PrepareData();
    }
    
    private void PrepareData()
    {
        candlestickData = Data.Select(d => new CandlestickPoint
        {
            X = d.Date,
            Y = new[] { d.Open, d.High, d.Low, d.Close }
        }).ToList();
    }
    
    private ApexChartOptions<CandlestickPoint> chartOptions = new()
    {
        Chart = new Chart
        {
            Type = ApexCharts.ChartType.Candlestick,
            Toolbar = new Toolbar { Show = true },
            Zoom = new Zoom { Enabled = true }
        },
        Xaxis = new XAxis
        {
            Type = XAxisType.Datetime,
            Title = new AxisTitle { Text = "Fecha" }
        },
        Yaxis = new List<YAxis>
        {
            new YAxis
            {
                Title = new AxisTitle { Text = "Precio ($)" },
                Labels = new YAxisLabels
                {
                    Formatter = "function(value) { return '$' + value.toFixed(2); }"
                }
            }
        },
        Colors = new List<string> { "#00E676", "#FF5722", "#2196F3" },
        Grid = new Grid
        {
            BorderColor = "#e0e0e0",
            StrokeDashArray = 3
        },
        Tooltip = new Tooltip
        {
            Enabled = true,
            Theme = Mode.Light
        }
    };
}