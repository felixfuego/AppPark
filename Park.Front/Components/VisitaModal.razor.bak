@using MudBlazor
@using Park.Comun.DTOs
@using Park.Comun.Enums
@using Park.Front.Services
@using Park.Front.Components
@inject IJSRuntime JSRuntime
@inject VisitaService VisitaService
@inject ColaboradorService ColaboradorService
@inject CompanyService CompanyService
@inject CentroService CentroService
@inject AuthService AuthService

<div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1" aria-labelledby="visitaModalLabel" aria-hidden="false">
    <div class="modal-dialog modal-xxl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="visitaModalLabel">@(IsEdit ? "Editar Visita" : "Nueva Visita Individual")</h5>
                <button type="button" class="btn-close" @onclick="CloseModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="visitaForm">
                    <!-- Información de la Solicitud -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-file-text me-2"></i>Información de la Solicitud</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="numeroSolicitud" class="form-label fw-bold">Número de Solicitud <span class="text-danger">*</span></label>                                        
                                        <input type="text" class="form-control" id="numeroSolicitud" @bind="createVisita.NumeroSolicitud" maxlength="50" required readonly>
                                        <div class="form-text">Generado automáticamente</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="fecha" class="form-label fw-bold">Fecha de Visita <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="fecha" @bind="createVisita.Fecha" @bind:format="yyyy-MM-dd" required>
                                        <div class="form-text">Fecha programada para la visita</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rango de Validez de la Visita -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-calendar-range me-2"></i>Rango de Validez de la Visita</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="fechaInicio" class="form-label fw-bold">Fecha de Inicio <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="fechaInicio" @bind="createVisita.FechaInicio" @bind:format="yyyy-MM-dd" required>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle me-1"></i>Fecha desde cuando la visita es válida
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="fechaVencimiento" class="form-label fw-bold">Fecha de Vencimiento <span class="text-danger">*</span></label>
                                        <input type="date" class="form-control" id="fechaVencimiento" @bind="createVisita.FechaVencimiento" @bind:format="yyyy-MM-dd" required>
                                        <div class="form-text">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Fecha hasta cuando la visita es válida
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tipo de Visita y Transporte -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-tags me-2"></i>Clasificación de la Visita</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="tipoVisita" class="form-label fw-bold">Tipo de Visita <span class="text-danger">*</span></label>
                                        <select class="form-select" id="tipoVisita" @bind="createVisita.TipoVisita" required>
                                            <option value="">Seleccionar tipo...</option>
                                            <option value="@TipoVisita.Contratista">Contratista</option>
                                            <option value="@TipoVisita.Empleado">Empleado</option>
                                            <option value="@TipoVisita.Proveedor">Proveedor</option>
                                            <option value="@TipoVisita.Visitante">Visitante</option>
                                            <option value="@TipoVisita.Cliente">Cliente</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="tipoTransporte" class="form-label fw-bold">Tipo de Transporte <span class="text-danger">*</span></label>
                                        <select class="form-select" id="tipoTransporte" @bind="createVisita.TipoTransporte" required>
                                            <option value="">Seleccionar transporte...</option>    
                                            <option value="@TipoTransporte.Vehiculo">Vehículo</option>
                                            <option value="@TipoTransporte.Moto">Moto</option>
                                            <option value="@TipoTransporte.Bicicleta">Bicicleta</option>
                                            <option value="@TipoTransporte.Peaton">Peatón</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información del Visitante -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-person-badge me-2"></i>Información del Visitante</h6>
                        </div>
                        <div class="card-body">
                            <!-- Selector de Visitante -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Seleccionar Visitante <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" 
                                                   class="form-control" 
                                                   @bind="selectedVisitorDisplay" 
                                                   placeholder="Buscar visitante existente..."
                                                   readonly>
                                            <button class="btn btn-outline-primary" type="button" @onclick="ShowVisitorSearch">
                                                <i class="bi bi-search me-1"></i>Buscar
                                            </button>
                                            <button class="btn btn-outline-secondary" type="button" @onclick="ClearVisitorSelection">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle me-1"></i>Busque un visitante existente o complete los datos manualmente
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Información del Visitante Seleccionado -->
                            @if (selectedVisitor != null)
                            {
                                <div class="alert alert-info">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-check-circle-fill text-success me-2"></i>
                                        <div>
                                            <strong>Visitante seleccionado:</strong> @selectedVisitor.FullName<br>
                                            <small class="text-muted">@selectedVisitor.DocumentType: @selectedVisitor.DocumentNumber</small>
                                        </div>
                                    </div>
                                </div>
                            }

                            <!-- Campos Manuales (como fallback) -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="nombreCompleto" class="form-label fw-bold">Nombre Completo <span class="text-danger">*</span></label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="nombreCompleto" 
                                               @bind="createVisita.NombreCompleto" 
                                               maxlength="200" 
                                               required 
                                               placeholder="Ej: Juan Pérez García"
                                               disabled="@(selectedVisitor != null)">
                                        <div class="form-text">
                                            <i class="bi bi-person me-1"></i>Nombre completo del visitante
                                            @if (selectedVisitor != null)
                                            {
                                                <span class="text-muted">(Completado automáticamente)</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="identidadVisitante" class="form-label fw-bold">Número de Identidad <span class="text-danger">*</span></label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="identidadVisitante" 
                                               @bind="createVisita.IdentidadVisitante" 
                                               maxlength="50" 
                                               required 
                                               placeholder="Ej: 1234567890"
                                               disabled="@(selectedVisitor != null)">
                                        <div class="form-text">
                                            <i class="bi bi-card-text me-1"></i>Número de cédula o documento de identidad
                                            @if (selectedVisitor != null)
                                            {
                                                <span class="text-muted">(Completado automáticamente)</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="procedencia" class="form-label fw-bold">Procedencia <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="procedencia" @bind="createVisita.Procedencia" maxlength="200" required placeholder="Ej: Empresa ABC, Ciudad">
                                        <div class="form-text">
                                            <i class="bi bi-building me-1"></i>Empresa o lugar de procedencia
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="placaVehiculo" class="form-label fw-bold">Placa del Vehículo</label>
                                        <input type="text" class="form-control" id="placaVehiculo" @bind="createVisita.PlacaVehiculo" maxlength="20" placeholder="Ej: ABC-123">
                                        <div class="form-text">
                                            <i class="bi bi-car-front me-1"></i>Opcional - Solo si viene en vehículo
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información de la Visita -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Detalles de la Visita</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="destino" class="form-label fw-bold">Destino <span class="text-danger">*</span></label>
                                        @if (isOperador && assignedCompany != null)
                                        {
                                            <input type="text" class="form-control" id="destino" @bind="createVisita.Destino" maxlength="200" required readonly>
                                            <div class="form-text">
                                                <i class="bi bi-geo-alt me-1"></i>Destino pre-llenado con la empresa asignada
                                            </div>
                                        }
                                        else
                                        {
                                            <input type="text" class="form-control" id="destino" @bind="createVisita.Destino" maxlength="200" required placeholder="Ej: Oficina Principal, Área de Producción">
                                            <div class="form-text">
                                                <i class="bi bi-geo-alt me-1"></i>Lugar específico dentro de la empresa
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="motivoVisita" class="form-label fw-bold">Motivo de la Visita <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="motivoVisita" @bind="createVisita.MotivoVisita" maxlength="500" rows="3" required placeholder="Describa el motivo de la visita..."></textarea>
                                        <div class="form-text">
                                            <i class="bi bi-chat-text me-1"></i>Descripción detallada del propósito
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Asignaciones y Ubicación -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-building me-2"></i>Asignaciones y Ubicación</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="idCompania" class="form-label fw-bold">Empresa <span class="text-danger">*</span></label>
                                        @if (isOperador && assignedCompany != null)
                                        {
                                            <input type="text" class="form-control" value="@assignedCompany.Name" readonly>
                                            <input type="hidden" @bind="createVisita.IdCompania" />
                                            <div class="form-text">
                                                <i class="bi bi-building me-1"></i>Empresa asignada (no se puede cambiar)
                                            </div>
                                        }
                                        else
                                        {
                                            <select class="form-select" id="idCompania" @bind="createVisita.IdCompania" required>
                                                <option value="">Seleccionar empresa...</option>
                                                @foreach (var empresa in empresas)
                                                {
                                                    <option value="@empresa.Id">@empresa.Name</option>
                                                }
                                            </select>
                                            <div class="form-text">
                                                <i class="bi bi-building me-1"></i>Empresa donde se realizará la visita
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="idCentro" class="form-label fw-bold">Centro <span class="text-danger">*</span></label>
                                        <select class="form-select" id="idCentro" @bind="createVisita.IdCentro" required>
                                            <option value="">Seleccionar centro...</option>
                                            @foreach (var centro in centros)
                                            {
                                                <option value="@centro.Id">@centro.Nombre</option>
            // Cargar centros según la empresa seleccionada
            await LoadCentrosForSelectedCompany();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error al cargar datos: {ex.Message}");
        }
    }

    private async Task LoadCentrosForSelectedCompany()
    {
        try
        {
            if (isOperador && assignedCompany != null)
            {
                // Para operadores, obtener las zonas de acceso de la empresa
                var zonasEmpresa = assignedCompany.ZonasAcceso?.Select(z => z.Id).ToList() ?? new List<int>();
                
                if (zonasEmpresa.Any())
                {
                    // Cargar todos los centros y filtrar por las zonas de la empresa
                    var allCentros = await CentroService.GetAllCentrosAsync();
                    centros = allCentros.Where(c => zonasEmpresa.Contains(c.IdZona)).ToList();
                }
                else
                {
                    // Si no hay zonas asignadas, cargar todos los centros (fallback)
                    centros = await CentroService.GetAllCentrosAsync();
                }
            }
            else
            {
                // Para admin, cargar todos los centros
                centros = await CentroService.GetAllCentrosAsync();
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error al cargar centros: {ex.Message}");
        }
    }

    private async Task SaveVisita()
    {
        if (isLoading) return;

        // Validaciones de fechas
        if (createVisita.FechaInicio >= createVisita.FechaVencimiento)
        {
            await JSRuntime.InvokeVoidAsync("alert", "La fecha de inicio debe ser anterior a la fecha de vencimiento");
            return;
        }

        if (createVisita.FechaVencimiento <= DateTime.Now)
        {
            await JSRuntime.InvokeVoidAsync("alert", "La fecha de vencimiento debe ser posterior a la fecha actual");
            return;
        }

        isLoading = true;
        StateHasChanged();

        try
        {
            if (IsEdit)
            {
                await VisitaService.UpdateVisitaAsync(updateVisita);
                await JSRuntime.InvokeVoidAsync("alert", "Visita actualizada exitosamente");
            }
            else
            {
                await VisitaService.CreateVisitaAsync(createVisita);
                await JSRuntime.InvokeVoidAsync("alert", "Visita creada exitosamente");
            }

            await OnSave.InvokeAsync();
            await OnCancel.InvokeAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CloseModal()
    {
        await OnCancel.InvokeAsync();
    }

    // Métodos para búsqueda de visitantes
    private void ShowVisitorSearch()
    {
        showVisitorSearchModal = true;
        StateHasChanged();
    }

    private void OnVisitorSelected(VisitorDto visitor)
    {
        selectedVisitor = visitor;
        selectedVisitorDisplay = $"{visitor.FullName} - {visitor.DocumentNumber}";
        
        // Llenar automáticamente los campos del visitante
        createVisita.NombreCompleto = visitor.FullName;
        createVisita.IdentidadVisitante = visitor.DocumentNumber;
        createVisita.Procedencia = visitor.Company ?? "";
        createVisita.IdVisitor = visitor.Id; // Asignar el ID del visitante
        
        showVisitorSearchModal = false;
        StateHasChanged();
    }

    private void OnVisitorSearchCancel()
    {
        showVisitorSearchModal = false;
        StateHasChanged();
    }

    private void ClearVisitorSelection()
    {
        selectedVisitor = null;
        selectedVisitorDisplay = "";
        createVisita.NombreCompleto = "";
        createVisita.IdentidadVisitante = "";
        createVisita.Procedencia = "";
        createVisita.IdVisitor = null; // Limpiar el ID del visitante
        StateHasChanged();
    }
}