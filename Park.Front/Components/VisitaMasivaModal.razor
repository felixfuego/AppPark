@using Park.Comun.DTOs
@using Park.Comun.Enums
@using Park.Front.Services
@inject IJSRuntime JSRuntime
@inject VisitaService VisitaService
@inject ColaboradorService ColaboradorService
@inject CompanyService CompanyService
@inject CentroService CentroService

<div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1" aria-labelledby="visitaMasivaModalLabel" aria-hidden="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="visitaMasivaModalLabel">Nueva Visita Masiva</h5>
                <button type="button" class="btn-close" @onclick="CloseModal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="visitaMasivaForm">
                    <!-- Información General -->
                    <!-- Información de la Solicitud Masiva -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-file-text me-2"></i>Información de la Solicitud Masiva</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="numeroSolicitud" class="form-label fw-bold">Número de Solicitud <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="numeroSolicitud" @bind="createVisitaMasiva.NumeroSolicitud" maxlength="50" required readonly>
                                        <div class="form-text">Generado automáticamente</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="fecha" class="form-label fw-bold">Fecha de Visita <span class="text-danger">*</span></label>
                                        <input type="datetime-local" class="form-control" id="fecha" @bind="fechaVisita" @bind:format="yyyy-MM-ddTHH:mm" required>
                                        <div class="form-text">Fecha programada para la visita masiva</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rango de Validez de la Visita -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-calendar-range me-2"></i>Rango de Validez de la Visita</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="fechaInicio" class="form-label fw-bold">Fecha de Inicio <span class="text-danger">*</span></label>
                                        <input type="datetime-local" class="form-control" id="fechaInicio" @bind="fechaInicio" @bind:format="yyyy-MM-ddTHH:mm" required>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle me-1"></i>Fecha desde cuando la visita es válida
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="fechaVencimiento" class="form-label fw-bold">Fecha de Vencimiento <span class="text-danger">*</span></label>
                                        <input type="datetime-local" class="form-control" id="fechaVencimiento" @bind="fechaVencimiento" @bind:format="yyyy-MM-ddTHH:mm" required>
                                        <div class="form-text">
                                            <i class="bi bi-exclamation-triangle me-1"></i>Fecha hasta cuando la visita es válida
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tipo de Visita y Transporte -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-tags me-2"></i>Clasificación de la Visita</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="tipoVisita" class="form-label fw-bold">Tipo de Visita <span class="text-danger">*</span></label>
                                        <select class="form-select" id="tipoVisita" @bind="createVisitaMasiva.TipoVisita" required>
                                            <option value="">Seleccionar tipo...</option>
                                            <option value="@TipoVisita.Contratista">Contratista</option>
                                            <option value="@TipoVisita.Empleado">Empleado</option>
                                            <option value="@TipoVisita.Proveedor">Proveedor</option>
                                            <option value="@TipoVisita.Visitante">Visitante</option>
                                            <option value="@TipoVisita.Cliente">Cliente</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="tipoTransporte" class="form-label fw-bold">Tipo de Transporte <span class="text-danger">*</span></label>
                                        <select class="form-select" id="tipoTransporte" @bind="createVisitaMasiva.TipoTransporte" required>
                                            <option value="">Seleccionar transporte...</option>
                                            <option value="@TipoTransporte.Vehiculo">Vehículo</option>
                                            <option value="@TipoTransporte.Moto">Moto</option>
                                            <option value="@TipoTransporte.Bicicleta">Bicicleta</option>
                                            <option value="@TipoTransporte.Peaton">Peatón</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información de la Visita -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Detalles de la Visita</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="procedencia" class="form-label fw-bold">Procedencia <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="procedencia" @bind="createVisitaMasiva.Procedencia" maxlength="200" required placeholder="Ej: Empresa ABC, Ciudad">
                                        <div class="form-text">
                                            <i class="bi bi-building me-1"></i>Empresa o lugar de procedencia
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="destino" class="form-label fw-bold">Destino <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="destino" @bind="createVisitaMasiva.Destino" maxlength="200" required placeholder="Ej: Oficina Principal, Área de Producción">
                                        <div class="form-text">
                                            <i class="bi bi-geo-alt me-1"></i>Lugar específico dentro de la empresa
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="mb-3">
                                        <label for="motivoVisita" class="form-label fw-bold">Motivo de la Visita <span class="text-danger">*</span></label>
                                        <textarea class="form-control" id="motivoVisita" @bind="createVisitaMasiva.MotivoVisita" maxlength="500" rows="3" required placeholder="Describa el motivo de la visita masiva..."></textarea>
                                        <div class="form-text">
                                            <i class="bi bi-chat-text me-1"></i>Descripción detallada del propósito de la visita
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Asignaciones y Ubicación -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="bi bi-building me-2"></i>Asignaciones y Ubicación</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="idCompania" class="form-label fw-bold">Empresa <span class="text-danger">*</span></label>
                                        <select class="form-select" id="idCompania" @bind="createVisitaMasiva.IdCompania" required>
                                            <option value="">Seleccionar empresa...</option>
                                            @foreach (var empresa in empresas)
                                            {
                                                <option value="@empresa.Id">@empresa.Name</option>
                                            }
                                        </select>
                                        <div class="form-text">
                                            <i class="bi bi-building me-1"></i>Empresa donde se realizará la visita
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="idCentro" class="form-label fw-bold">Centro <span class="text-danger">*</span></label>
                                        <select class="form-select" id="idCentro" @bind="createVisitaMasiva.IdCentro" required>
                                            <option value="">Seleccionar centro...</option>
                                            @foreach (var centro in centros)
                                            {
                                                <option value="@centro.Id">@centro.Nombre</option>
                                            }
                                        </select>
                                        <div class="form-text">
                                            <i class="bi bi-geo-alt me-1"></i>Centro específico dentro de la empresa
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="idSolicitante" class="form-label fw-bold">Solicitante <span class="text-danger">*</span></label>
                                        <select class="form-select" id="idSolicitante" @bind="createVisitaMasiva.IdSolicitante" required>
                                            <option value="">Seleccionar solicitante...</option>
                                            @foreach (var colaborador in colaboradores)
                                            {
                                                <option value="@colaborador.Id">@colaborador.Nombre</option>
                                            }
                                        </select>
                                        <div class="form-text">
                                            <i class="bi bi-person me-1"></i>Colaborador que solicita la visita
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="idRecibidoPor" class="form-label fw-bold">Recibido Por <span class="text-danger">*</span></label>
                                        <select class="form-select" id="idRecibidoPor" @bind="createVisitaMasiva.IdRecibidoPor" required>
                                            <option value="">Seleccionar responsable...</option>
                                            @foreach (var colaborador in colaboradores)
                                            {
                                                <option value="@colaborador.Id">@colaborador.Nombre</option>
                                            }
                                        </select>
                                        <div class="form-text">
                                            <i class="bi bi-person-check me-1"></i>Colaborador que recibirá a los visitantes
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de Visitantes -->
                    <div class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="bi bi-people-fill me-2"></i>Lista de Visitantes</h6>
                            <button type="button" class="btn btn-sm btn-success" @onclick="AddVisitante">
                                <i class="bi bi-plus-circle me-1"></i> Agregar Visitante
                            </button>
                        </div>
                        <div class="card-body">
                            @if (createVisitaMasiva.Visitantes.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Nombre Completo</th>
                                                <th>Identidad</th>
                                                <th>Placa Vehículo</th>
                                                <th width="100">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @for (int i = 0; i < createVisitaMasiva.Visitantes.Count; i++)
                                            {
                                                var index = i;
                                                <tr>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm" 
                                                               @bind="createVisitaMasiva.Visitantes[index].NombreCompleto" 
                                                               placeholder="Nombre completo" required />
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm" 
                                                               @bind="createVisitaMasiva.Visitantes[index].IdentidadVisitante" 
                                                               placeholder="Identidad" required />
                                                    </td>
                                                    <td>
                                                        <input type="text" class="form-control form-control-sm" 
                                                               @bind="createVisitaMasiva.Visitantes[index].PlacaVehiculo" 
                                                               placeholder="Placa (opcional)" />
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                                                @onclick="() => RemoveVisitante(index)">
                                                            <i class="bi bi-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted py-3">
                                    <i class="bi bi-people fs-1"></i>
                                    <p class="mt-2">No hay visitantes agregados</p>
                                    <p class="small">Haz clic en "Agregar Visitante" para comenzar</p>
                                </div>
                            }
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancelar</button>
                <button type="button" class="btn btn-primary" @onclick="SaveVisitaMasiva" disabled="@(isLoading || !createVisitaMasiva.Visitantes.Any())">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    Crear Visita Masiva
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private CreateVisitaMasivaDto createVisitaMasiva = new();
    private bool isLoading = false;

    // Datos para dropdowns
    private List<CompanyDto> empresas = new();
    private List<CentroDto> centros = new();
    private List<ColaboradorDto> colaboradores = new();

    // Fecha como DateTime para el binding
    private DateTime fechaVisita
    {
        get => createVisitaMasiva.Fecha;
        set => createVisitaMasiva.Fecha = value;
    }

    // Fecha de inicio como DateTime para el binding
    private DateTime fechaInicio
    {
        get => createVisitaMasiva.FechaInicio;
        set => createVisitaMasiva.FechaInicio = value;
    }

    // Fecha de vencimiento como DateTime para el binding
    private DateTime fechaVencimiento
    {
        get => createVisitaMasiva.FechaVencimiento;
        set => createVisitaMasiva.FechaVencimiento = value;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadDropdownData();
        createVisitaMasiva.NumeroSolicitud = VisitaService.GenerarNumeroSolicitud();
    }

    private async Task LoadDropdownData()
    {
        try
        {
            var empresasTask = CompanyService.GetAllCompaniesAsync();
            var centrosTask = CentroService.GetAllCentrosAsync();
            var colaboradoresTask = ColaboradorService.GetAllColaboradoresAsync();

            await Task.WhenAll(empresasTask, centrosTask, colaboradoresTask);

            empresas = empresasTask.Result;
            centros = centrosTask.Result;
            colaboradores = colaboradoresTask.Result;
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error al cargar datos: {ex.Message}");
        }
    }

    private void AddVisitante()
    {
        createVisitaMasiva.Visitantes.Add(new VisitaMasivaVisitanteDto());
    }

    private void RemoveVisitante(int index)
    {
        if (index >= 0 && index < createVisitaMasiva.Visitantes.Count)
        {
            createVisitaMasiva.Visitantes.RemoveAt(index);
        }
    }

    private async Task SaveVisitaMasiva()
    {
        if (isLoading) return;

        // Validaciones de fechas
        if (fechaInicio >= fechaVencimiento)
        {
            await JSRuntime.InvokeVoidAsync("alert", "La fecha de inicio debe ser anterior a la fecha de vencimiento");
            return;
        }

        if (fechaVencimiento <= DateTime.Now)
        {
            await JSRuntime.InvokeVoidAsync("alert", "La fecha de vencimiento debe ser posterior a la fecha actual");
            return;
        }

        isLoading = true;
        StateHasChanged();

        try
        {
            await VisitaService.CreateVisitaMasivaAsync(createVisitaMasiva);
            await JSRuntime.InvokeVoidAsync("alert", "Visita masiva creada exitosamente");
            await OnSave.InvokeAsync();
            await OnCancel.InvokeAsync();
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CloseModal()
    {
        await OnCancel.InvokeAsync();
    }
}